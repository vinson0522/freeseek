<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self' http://127.0.0.1:* http://localhost:*;">
<title>FreeSeek - DeepSeek åå‘ä»£ç†æ§åˆ¶é¢æ¿</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, 'Segoe UI', sans-serif; background: #0a0a0f; color: #e0e0e0; min-height: 100vh; }
  .topbar { background: #12121a; border-bottom: 1px solid #1e1e2e; padding: 16px 32px; display: flex; align-items: center; justify-content: space-between; -webkit-app-region: drag; }
  .topbar h1 { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
  .topbar h1 span { color: #4f8ff7; }
  .topbar .badge { font-size: 11px; padding: 3px 10px; border-radius: 20px; }
  .badge-ok { background: #1a3a2a; color: #4ade80; }
  .badge-off { background: #3a1a1a; color: #f87171; }
  .main { display: grid; grid-template-columns: 260px 1fr; min-height: calc(100vh - 57px); }
  .sidebar { background: #0e0e16; border-right: 1px solid #1e1e2e; padding: 20px 0; }
  .sidebar .nav-item { padding: 10px 24px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 10px; color: #888; transition: all .15s; }
  .sidebar .nav-item:hover { background: #16161f; color: #ccc; }
  .sidebar .nav-item.active { background: #1a1a2e; color: #4f8ff7; border-right: 2px solid #4f8ff7; }
  .sidebar .nav-item svg { width: 18px; height: 18px; flex-shrink: 0; }
  .sidebar .section-title { font-size: 11px; text-transform: uppercase; color: #555; padding: 20px 24px 8px; letter-spacing: 1px; }
  .content { padding: 32px; overflow-y: auto; }
  .page { display: none; }
  .page.active { display: block; }
  .card { background: #12121a; border: 1px solid #1e1e2e; border-radius: 12px; padding: 24px; margin-bottom: 20px; }
  .card h3 { font-size: 15px; margin-bottom: 16px; color: #ccc; }
  .card-grid { display: grid; gap: 16px; }
  .stat { text-align: center; }
  .stat .value { font-size: 32px; font-weight: 700; color: #4f8ff7; }
  .stat .value.green { color: #4ade80; }
  .stat .value.yellow { color: #facc15; }
  .stat .label { font-size: 12px; color: #666; margin-top: 4px; }
  .btn { padding: 8px 20px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: 500; transition: all .15s; -webkit-app-region: no-drag; }
  .btn-primary { background: #4f8ff7; color: #fff; }
  .btn-primary:hover { background: #3a7ae0; }
  .btn-danger { background: #dc2626; color: #fff; }
  .btn-danger:hover { background: #b91c1c; }
  .btn-outline { background: transparent; border: 1px solid #333; color: #aaa; }
  .btn-outline:hover { border-color: #4f8ff7; color: #4f8ff7; }
  .btn-group { display: flex; gap: 10px; margin-top: 16px; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
</style>
</head>
<body>
<style>
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { text-align: left; padding: 10px 12px; color: #666; border-bottom: 1px solid #1e1e2e; font-weight: 500; }
  td { padding: 10px 12px; border-bottom: 1px solid #141420; }
  .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
  .dot.green { background: #4ade80; } .dot.red { background: #f87171; } .dot.yellow { background: #facc15; }
  .code-block { background: #0a0a12; border: 1px solid #1e1e2e; border-radius: 8px; padding: 16px; font-family: 'Fira Code','Consolas',monospace; font-size: 12px; line-height: 1.6; overflow-x: auto; color: #a0a0b0; position: relative; white-space: pre; }
  .code-block .copy-btn { position: absolute; top: 8px; right: 8px; background: #222; border: 1px solid #333; color: #888; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; }
  .code-block .copy-btn:hover { color: #4f8ff7; border-color: #4f8ff7; }
  input[type="text"], input[type="password"], select { background: #0a0a12; border: 1px solid #1e1e2e; color: #e0e0e0; padding: 8px 12px; border-radius: 6px; font-size: 13px; width: 100%; }
  input:focus, select:focus { outline: none; border-color: #4f8ff7; }
  .form-row { margin-bottom: 14px; }
  .form-row label { display: block; font-size: 12px; color: #888; margin-bottom: 6px; }
  .log-area { background: #050508; border: 1px solid #1e1e2e; border-radius: 8px; padding: 16px; font-family: monospace; font-size: 12px; height: 400px; overflow-y: auto; line-height: 1.8; }
  .log-line { display: flex; gap: 10px; }
  .log-time { color: #555; flex-shrink: 0; }
  .log-level { flex-shrink: 0; font-weight: 600; }
  .log-level.info { color: #4f8ff7; } .log-level.ok { color: #4ade80; } .log-level.warn { color: #facc15; } .log-level.err { color: #f87171; }
  .log-msg { color: #999; }
  .chat-box { background: #0a0a12; border: 1px solid #1e1e2e; border-radius: 8px; height: 400px; display: flex; flex-direction: column; }
  .chat-messages { flex: 1; overflow-y: auto; padding: 16px; }
  .chat-msg { margin-bottom: 12px; }
  .chat-msg .role { font-size: 11px; color: #666; margin-bottom: 4px; }
  .chat-msg .bubble { padding: 10px 14px; border-radius: 10px; font-size: 13px; line-height: 1.6; max-width: 80%; white-space: pre-wrap; }
  .chat-msg.user .bubble { background: #1a2a4a; color: #a0c4ff; margin-left: auto; }
  .chat-msg.assistant .bubble { background: #1a1a2e; color: #ccc; }
  .thinking-block { background: #0d0d1a; border-left: 3px solid #6366f1; padding: 10px 14px; margin-bottom: 8px; border-radius: 0 8px 8px 0; font-size: 12px; color: #8888aa; line-height: 1.6; white-space: pre-wrap; max-height: 200px; overflow-y: auto; }
  .thinking-toggle { font-size: 11px; color: #6366f1; cursor: pointer; margin-bottom: 6px; user-select: none; }
  .thinking-toggle:hover { color: #818cf8; }
  .chat-input { display: flex; gap: 8px; padding: 12px; border-top: 1px solid #1e1e2e; }
  .chat-input input { flex: 1; }
  .pulse { animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:.5; } }
  .typing::after { content: 'â–Š'; animation: blink .8s infinite; }
  @keyframes blink { 0%,100% { opacity:1; } 50% { opacity:0; } }
</style>

<!-- é¡¶æ  -->
<div class="topbar">
  <h1>ğŸ”€ <span>FreeSeek</span> â€” DeepSeek Reverse Proxy</h1>
  <div style="display:flex;align-items:center;gap:16px;">
    <span class="badge badge-off" id="statusBadge">â— å·²åœæ­¢</span>
    <span style="font-size:12px;color:#555;" id="versionInfo">v1.0.0</span>
  </div>
</div>

<div class="main">
  <!-- ä¾§è¾¹æ  -->
  <div class="sidebar">
    <div class="section-title">æ¦‚è§ˆ</div>
    <div class="nav-item active" onclick="showPage('dashboard',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      ä»ªè¡¨ç›˜
    </div>
    <div class="section-title">å‡­è¯</div>
    <div class="nav-item" onclick="showPage('auth',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
      ç™»å½• & å‡­è¯
    </div>
    <div class="section-title">æœåŠ¡</div>
    <div class="nav-item" onclick="showPage('api',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
      API æ¥å£
    </div>
    <div class="nav-item" onclick="showPage('test',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
      èŠå¤©æµ‹è¯•
    </div>
    <div class="nav-item" onclick="showPage('logs',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      è¿è¡Œæ—¥å¿—
    </div>
    <div class="section-title">é…ç½®</div>
    <div class="nav-item" onclick="showPage('settings',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9c.1-.6-.1-1.3-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06c.5.5 1.2.7 1.82.33a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09c.1.6.5 1.1 1 1.51.6.3 1.3.2 1.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06c-.5.5-.7 1.2-.33 1.82.2.4.7.8 1.51 1H21a2 2 0 010 4h-.09c-.6.1-1.1.5-1.51 1z"/></svg>
      è®¾ç½®
    </div>
  </div>

  <div class="content">

    <!-- ===== ä»ªè¡¨ç›˜ ===== -->
    <div class="page active" id="page-dashboard">
      <div class="card">
        <h3>æœåŠ¡çŠ¶æ€</h3>
        <div class="card-grid" style="grid-template-columns:repeat(4,1fr);">
          <div class="stat"><div class="value" id="dashStatus">â€”</div><div class="label">çŠ¶æ€</div></div>
          <div class="stat"><div class="value" id="dashPort">3000</div><div class="label">ç›‘å¬ç«¯å£</div></div>
          <div class="stat"><div class="value" id="dashRequests">0</div><div class="label">æ€»è¯·æ±‚æ•°</div></div>
          <div class="stat"><div class="value" id="dashTokens">0</div><div class="label">æ€» Token</div></div>
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" id="btnStartServer" onclick="toggleServer()">â–¶ å¯åŠ¨æœåŠ¡</button>
        </div>
      </div>
      <div class="card">
        <h3>å‡­è¯ä¿¡æ¯</h3>
        <table>
          <tr><th>é¡¹ç›®</th><th>çŠ¶æ€</th><th>è¯¦æƒ…</th></tr>
          <tr><td>Cookie</td><td id="dashCookieStatus"><span class="dot red"></span>æœªè®¾ç½®</td><td id="dashCookieDetail" style="color:#555;">â€”</td></tr>
          <tr><td>Bearer Token</td><td id="dashBearerStatus"><span class="dot red"></span>æœªè®¾ç½®</td><td id="dashBearerDetail" style="color:#555;">â€”</td></tr>
          <tr><td>æ•è·æ—¶é—´</td><td>â€”</td><td id="dashCapturedAt" style="color:#555;">â€”</td></tr>
        </table>
      </div>
      <div class="card">
        <h3>å¯ç”¨æ¨¡å‹</h3>
        <table>
          <tr><th>æ¨¡å‹ ID</th><th>åç§°</th><th>æ¨ç†</th></tr>
          <tr><td><code>deepseek-chat</code></td><td>DeepSeek Chat (V3)</td><td>â€”</td></tr>
          <tr><td><code>deepseek-reasoner</code></td><td>DeepSeek Reasoner (R1)</td><td>âœ… æ·±åº¦æ€è€ƒ</td></tr>
          <tr><td><code>deepseek-chat-search</code></td><td>DeepSeek Chat + æœç´¢</td><td>â€”</td></tr>
          <tr><td><code>deepseek-reasoner-search</code></td><td>DeepSeek Reasoner + æœç´¢</td><td>âœ… æ·±åº¦æ€è€ƒ</td></tr>
        </table>
      </div>
      <div class="card">
        <h3>å¿«é€Ÿæ¥å…¥</h3>
        <div class="code-block"><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button>curl -N http://127.0.0.1:3000/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{"model":"deepseek-chat","messages":[{"role":"user","content":"ä½ å¥½"}],"stream":true}'</div>
      </div>
    </div>

    <!-- ===== ç™»å½• & å‡­è¯ ===== -->
    <div class="page" id="page-auth">
      <div class="card">
        <h3>å‡­è¯æ•è·</h3>
        <p style="font-size:13px;color:#888;margin-bottom:16px;">é€šè¿‡æµè§ˆå™¨è‡ªåŠ¨åŒ–æ•è· DeepSeek ç½‘é¡µç‰ˆç™»å½•å‡­è¯ã€‚ç‚¹å‡»æŒ‰é’®ä¼šæ‰“å¼€ Chromeï¼Œè¯·åœ¨æµè§ˆå™¨ä¸­å®Œæˆç™»å½•ã€‚</p>
        <div class="btn-group">
          <button class="btn btn-primary" id="btnAutoAuth" onclick="startAutoAuth()">ğŸ”‘ å¯åŠ¨è‡ªåŠ¨æ•è·</button>
          <button class="btn btn-outline" onclick="toggleManualAuth()">ğŸ“‹ æ‰‹åŠ¨ç²˜è´´å‡­è¯</button>
        </div>
        <div id="authProgress" style="margin-top:16px;display:none;">
          <div style="display:flex;align-items:center;gap:10px;">
            <div class="pulse" style="width:10px;height:10px;border-radius:50%;background:#4f8ff7;"></div>
            <span id="authStatus" style="font-size:13px;color:#4f8ff7;">æ­£åœ¨å¯åŠ¨æµè§ˆå™¨...</span>
          </div>
        </div>
      </div>
      <div class="card" id="manualAuth" style="display:none;">
        <h3>æ‰‹åŠ¨ç²˜è´´å‡­è¯</h3>
        <p style="font-size:13px;color:#888;margin-bottom:16px;">chat.deepseek.com â†’ F12 â†’ Network â†’ æ‰¾åˆ° /api/v0/ è¯·æ±‚ â†’ å¤åˆ¶è¯·æ±‚å¤´</p>
        <div class="form-row"><label>Cookie</label><input type="text" id="manualCookie" placeholder="ds_session_id=xxx; d_id=xxx; ..."/></div>
        <div class="form-row"><label>Authorization Bearer Token</label><input type="password" id="manualBearer" placeholder="eyJhbGciOiJIUzI1NiIs..."/></div>
        <div class="form-row"><label>User-Agentï¼ˆå¯é€‰ï¼‰</label><input type="text" id="manualUA" placeholder="Mozilla/5.0 ..."/></div>
        <div class="btn-group"><button class="btn btn-primary" onclick="saveManualAuth()">ğŸ’¾ ä¿å­˜å‡­è¯</button></div>
      </div>
      <div class="card">
        <h3>å½“å‰å‡­è¯çŠ¶æ€</h3>
        <table id="authStatusTable">
          <tr><th>å­—æ®µ</th><th>å€¼</th></tr>
          <tr><td>çŠ¶æ€</td><td id="authCredsStatus">åŠ è½½ä¸­...</td></tr>
        </table>
        <div class="btn-group">
          <button class="btn btn-danger" style="font-size:12px;" onclick="doClearCreds()">ğŸ—‘ï¸ æ¸…é™¤å‡­è¯</button>
        </div>
      </div>
    </div>

    <!-- ===== API æ¥å£ ===== -->
    <div class="page" id="page-api">
      <div class="card">
        <h3>OpenAI å…¼å®¹ API ç«¯ç‚¹</h3>
        <table>
          <tr><th>æ–¹æ³•</th><th>è·¯å¾„</th><th>è¯´æ˜</th></tr>
          <tr><td><span style="color:#4ade80;font-weight:600;">GET</span></td><td><code>/v1/models</code></td><td>è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨</td></tr>
          <tr><td><span style="color:#facc15;font-weight:600;">POST</span></td><td><code>/v1/chat/completions</code></td><td>èŠå¤©è¡¥å…¨ï¼ˆæµå¼/éæµå¼ï¼‰</td></tr>
          <tr><td><span style="color:#4ade80;font-weight:600;">GET</span></td><td><code>/health</code></td><td>å¥åº·æ£€æŸ¥ & å‡­è¯çŠ¶æ€</td></tr>
        </table>
      </div>
      <div class="card">
        <h3>è¯·æ±‚ç¤ºä¾‹ â€” æµå¼</h3>
        <div class="code-block"><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button>curl -N http://127.0.0.1:3000/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{
    "model": "deepseek-chat",
    "messages": [
      {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„åŠ©æ‰‹"},
      {"role": "user", "content": "ç”¨ Python å†™ä¸€ä¸ªå¿«é€Ÿæ’åº"}
    ],
    "stream": true
  }'</div>
      </div>
      <div class="card">
        <h3>æœ¬åœ° AI åº”ç”¨æ¥å…¥</h3>
        <table>
          <tr><th>åº”ç”¨</th><th>é…ç½®</th></tr>
          <tr><td>Cursor</td><td>Settings â†’ Models â†’ OpenAI API Base: <code>http://127.0.0.1:3000/v1</code></td></tr>
          <tr><td>Continue</td><td>config.json â†’ provider: openai, apiBase: <code>http://127.0.0.1:3000/v1</code></td></tr>
          <tr><td>Open WebUI</td><td>è®¾ç½® â†’ è¿æ¥ â†’ API Base URL: <code>http://127.0.0.1:3000/v1</code></td></tr>
          <tr><td>ChatBox</td><td>è®¾ç½® â†’ API åŸŸå: <code>http://127.0.0.1:3000</code></td></tr>
          <tr><td>ä»»æ„ OpenAI SDK</td><td><code>baseURL: "http://127.0.0.1:3000/v1"</code>, apiKey éšä¾¿å¡«</td></tr>
        </table>
      </div>
    </div>

    <!-- ===== èŠå¤©æµ‹è¯• ===== -->
    <div class="page" id="page-test">
      <div class="card">
        <h3>åœ¨çº¿æµ‹è¯•</h3>
        <div style="display:flex;gap:12px;margin-bottom:16px;">
          <div class="form-row" style="flex:1;margin:0;"><label>æ¨¡å‹</label><select id="testModel"><option value="deepseek-chat">deepseek-chat</option><option value="deepseek-reasoner">deepseek-reasoner</option><option value="deepseek-chat-search">deepseek-chat-search</option><option value="deepseek-reasoner-search">deepseek-reasoner-search</option></select></div>
          <div class="form-row" style="width:100px;margin:0;"><label>æµå¼</label><select id="testStream"><option value="true">æ˜¯</option><option value="false">å¦</option></select></div>
        </div>
        <div class="chat-box">
          <div class="chat-messages" id="chatMessages"></div>
          <div class="chat-input">
            <input type="text" placeholder="è¾“å…¥æ¶ˆæ¯..." id="chatInput" onkeydown="if(event.key==='Enter')sendMsg()"/>
            <button class="btn btn-primary" onclick="sendMsg()">å‘é€</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== è¿è¡Œæ—¥å¿— ===== -->
    <div class="page" id="page-logs">
      <div class="card">
        <h3>å®æ—¶æ—¥å¿— <span style="float:right;"><button class="btn btn-outline" style="font-size:11px;padding:4px 12px;" onclick="clearLogs()">æ¸…ç©º</button></span></h3>
        <div class="log-area" id="logArea"></div>
      </div>
    </div>

    <!-- ===== è®¾ç½® ===== -->
    <div class="page" id="page-settings">
      <div class="card">
        <h3>æœåŠ¡é…ç½®</h3>
        <div class="form-row"><label>ç›‘å¬ç«¯å£</label><input type="text" id="settingPort" value="3000" style="width:120px;"/></div>
        <div class="form-row"><label>ç›‘å¬åœ°å€</label><select style="width:220px;" disabled><option>127.0.0.1ï¼ˆä»…æœ¬æœºï¼‰</option></select></div>
      </div>
      <div class="card">
        <h3>è¯´æ˜</h3>
        <div style="font-size:13px;color:#888;line-height:1.8;">
          <p>FreeSeek æ˜¯ä¸€ä¸ª DeepSeek ç½‘é¡µç‰ˆåå‘ä»£ç†å·¥å…·ï¼Œé€šè¿‡æµè§ˆå™¨è‡ªåŠ¨åŒ–æ•è·ç™»å½•å‡­è¯ï¼Œåœ¨æœ¬åœ°æä¾›å…¼å®¹ OpenAI API æ ¼å¼çš„ HTTP æœåŠ¡ã€‚</p>
          <p style="margin-top:8px;">æ­¤æ–¹æ¡ˆä»…ä¾›ä¸ªäººå­¦ä¹ ç ”ç©¶ä½¿ç”¨ã€‚ä½¿ç”¨æ—¶è¯·éµå®ˆ DeepSeek çš„æœåŠ¡æ¡æ¬¾ã€‚</p>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->

<script>
// ========== é¡µé¢å¯¼èˆª ==========
function showPage(id, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  if (el) el.classList.add('active');
}

function copyCode(btn) {
  const code = btn.parentElement.textContent.replace('å¤åˆ¶', '').trim();
  navigator.clipboard?.writeText(code);
  btn.textContent = 'å·²å¤åˆ¶ âœ“';
  setTimeout(() => btn.textContent = 'å¤åˆ¶', 1500);
}

// ========== çŠ¶æ€åˆ·æ–° ==========
async function refreshStatus() {
  try {
    const status = await window.freeseek.getServerStatus();
    const badge = document.getElementById('statusBadge');
    const dashStatus = document.getElementById('dashStatus');
    const btnStart = document.getElementById('btnStartServer');

    if (status.running) {
      badge.className = 'badge badge-ok';
      badge.textContent = 'â— è¿è¡Œä¸­';
      dashStatus.textContent = 'â—';
      dashStatus.className = 'value green';
      btnStart.textContent = 'â¹ åœæ­¢æœåŠ¡';
      btnStart.className = 'btn btn-danger';
      document.getElementById('dashPort').textContent = status.port;
    } else {
      badge.className = 'badge badge-off';
      badge.textContent = 'â— å·²åœæ­¢';
      dashStatus.textContent = 'â€”';
      dashStatus.className = 'value';
      btnStart.textContent = 'â–¶ å¯åŠ¨æœåŠ¡';
      btnStart.className = 'btn btn-primary';
    }

    // åˆ·æ–°ç»Ÿè®¡
    const stats = await window.freeseek.getStats();
    document.getElementById('dashRequests').textContent = stats.requestCount;
    document.getElementById('dashTokens').textContent = formatTokens(stats.totalTokens);

    // åˆ·æ–°å‡­è¯
    await refreshCredentials();
  } catch(e) {
    console.error('refreshStatus error:', e);
  }
}

async function refreshCredentials() {
  const creds = await window.freeseek.getCredentials();
  const cookieStatus = document.getElementById('dashCookieStatus');
  const cookieDetail = document.getElementById('dashCookieDetail');
  const bearerStatus = document.getElementById('dashBearerStatus');
  const bearerDetail = document.getElementById('dashBearerDetail');
  const capturedAt = document.getElementById('dashCapturedAt');
  const authCredsStatus = document.getElementById('authCredsStatus');

  if (creds) {
    cookieStatus.innerHTML = '<span class="dot green"></span>æœ‰æ•ˆ';
    cookieDetail.textContent = creds.cookieCount + ' é¡¹' + (creds.hasSessionId ? ' (å« session)' : '');
    bearerStatus.innerHTML = '<span class="dot green"></span>æœ‰æ•ˆ';
    bearerDetail.textContent = 'é•¿åº¦ ' + creds.bearerLength + ' å­—ç¬¦';
    capturedAt.textContent = new Date(creds.capturedAt).toLocaleString('zh-CN');
    authCredsStatus.innerHTML = '<span class="dot green"></span>å·²é…ç½® â€” Cookie ' + creds.cookieCount + ' é¡¹, Bearer ' + creds.bearerLength + ' å­—ç¬¦';
  } else {
    cookieStatus.innerHTML = '<span class="dot red"></span>æœªè®¾ç½®';
    cookieDetail.textContent = 'â€”';
    bearerStatus.innerHTML = '<span class="dot red"></span>æœªè®¾ç½®';
    bearerDetail.textContent = 'â€”';
    capturedAt.textContent = 'â€”';
    authCredsStatus.innerHTML = '<span class="dot red"></span>æœªé…ç½® â€” è¯·å…ˆæ•è·æˆ–æ‰‹åŠ¨ç²˜è´´å‡­è¯';
  }
}

function formatTokens(n) {
  if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
  if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
  return String(n);
}

// ========== æœåŠ¡æ§åˆ¶ ==========
async function toggleServer() {
  const status = await window.freeseek.getServerStatus();
  const btn = document.getElementById('btnStartServer');
  btn.disabled = true;

  if (status.running) {
    await window.freeseek.stopServer();
  } else {
    const port = parseInt(document.getElementById('settingPort').value) || 3000;
    await window.freeseek.startServer(port);
  }

  btn.disabled = false;
  setTimeout(refreshStatus, 500);
}

// ========== å‡­è¯ç®¡ç† ==========
async function startAutoAuth() {
  const btn = document.getElementById('btnAutoAuth');
  const prog = document.getElementById('authProgress');
  const status = document.getElementById('authStatus');
  btn.disabled = true;
  prog.style.display = 'block';
  status.textContent = 'æ­£åœ¨å¯åŠ¨...';

  const result = await window.freeseek.startAuth();
  if (result.ok) {
    status.textContent = 'âœ… å‡­è¯æ•è·æˆåŠŸï¼';
    status.style.color = '#4ade80';
  } else {
    status.textContent = 'âŒ ' + result.error;
    status.style.color = '#f87171';
  }
  btn.disabled = false;
  refreshStatus();
}

function toggleManualAuth() {
  const el = document.getElementById('manualAuth');
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

async function saveManualAuth() {
  const cookie = document.getElementById('manualCookie').value.trim();
  const bearer = document.getElementById('manualBearer').value.trim();
  const ua = document.getElementById('manualUA').value.trim();
  if (!cookie || !bearer) { alert('è¯·å¡«å†™ Cookie å’Œ Bearer Token'); return; }
  const result = await window.freeseek.saveManualCredentials({ cookie, bearer, userAgent: ua });
  if (result.ok) {
    alert('å‡­è¯å·²ä¿å­˜');
    refreshStatus();
  } else {
    alert('ä¿å­˜å¤±è´¥: ' + result.error);
  }
}

async function doClearCreds() {
  if (!confirm('ç¡®å®šè¦æ¸…é™¤å‡­è¯å—ï¼Ÿ')) return;
  await window.freeseek.clearCredentials();
  refreshStatus();
}

// ========== æ—¥å¿— ==========
function appendLog(log) {
  const area = document.getElementById('logArea');
  const div = document.createElement('div');
  div.className = 'log-line';
  div.innerHTML = '<span class="log-time">' + log.time + '</span>'
    + '<span class="log-level ' + log.level + '">' + log.level.toUpperCase() + '</span>'
    + '<span class="log-msg">' + escapeHtml(log.msg) + '</span>';
  area.appendChild(div);
  area.scrollTop = area.scrollHeight;
}

function clearLogs() {
  document.getElementById('logArea').innerHTML = '';
}

function escapeHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ========== èŠå¤©æµ‹è¯• ==========
const chatHistory = [];

async function sendMsg() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';

  chatHistory.push({ role: 'user', content: msg });
  appendChatMsg('user', msg);

  const model = document.getElementById('testModel').value;
  const stream = document.getElementById('testStream').value === 'true';
  const port = parseInt(document.getElementById('settingPort').value) || 3000;

  // æ·»åŠ åŠ©æ‰‹å ä½
  const msgId = 'msg-' + Date.now();
  appendAssistantPlaceholder(msgId);

  try {
    const res = await fetch('http://127.0.0.1:' + port + '/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ model, messages: chatHistory, stream }),
    });

    if (!res.ok) throw new Error('HTTP ' + res.status);

    if (stream && res.body) {
      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let fullContent = '';
      let fullReasoning = '';
      let buf = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buf += decoder.decode(value, { stream: true });
        const lines = buf.split('\n');
        buf = lines.pop() || '';
        for (const line of lines) {
          const trimmed = line.trim();
          if (!trimmed.startsWith('data: ') || trimmed === 'data: [DONE]') continue;
          try {
            const data = JSON.parse(trimmed.slice(6));
            const delta = data.choices?.[0]?.delta;
            if (delta?.content) fullContent += delta.content;
            if (delta?.reasoning_content) fullReasoning += delta.reasoning_content;
          } catch {}
        }
        updateAssistantMsg(msgId, fullReasoning, fullContent);
      }
      chatHistory.push({ role: 'assistant', content: fullContent });
    } else {
      const data = await res.json();
      const content = data.choices?.[0]?.message?.content || '(ç©ºå“åº”)';
      const reasoning = data.choices?.[0]?.message?.reasoning_content || '';
      updateAssistantMsg(msgId, reasoning, content);
      chatHistory.push({ role: 'assistant', content });
    }
  } catch (err) {
    const contentEl = document.getElementById(msgId + '-content');
    if (contentEl) contentEl.textContent = 'âŒ è¯·æ±‚å¤±è´¥: ' + err.message;
  }
}

function appendAssistantPlaceholder(msgId) {
  const msgs = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'chat-msg assistant';
  div.id = msgId;
  div.innerHTML = '<div class="role">DeepSeek</div>'
    + '<div class="thinking-toggle" id="' + msgId + '-thinkToggle" style="display:none;" onclick="toggleThinking(\'' + msgId + '\')">ğŸ’­ æ€è€ƒè¿‡ç¨‹ â–¸</div>'
    + '<div class="thinking-block" id="' + msgId + '-thinking" style="display:none;"></div>'
    + '<div class="bubble" id="' + msgId + '-content"><span class="typing">æ­£åœ¨ç”Ÿæˆå›å¤</span></div>';
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function updateAssistantMsg(msgId, reasoning, content) {
  const thinkToggle = document.getElementById(msgId + '-thinkToggle');
  const thinkBlock = document.getElementById(msgId + '-thinking');
  const contentEl = document.getElementById(msgId + '-content');

  if (reasoning && thinkToggle && thinkBlock) {
    thinkToggle.style.display = 'block';
    thinkBlock.textContent = reasoning;
  }
  if (contentEl) {
    contentEl.textContent = content || (reasoning ? '(æ€è€ƒä¸­...)' : '...');
  }

  const msgs = document.getElementById('chatMessages');
  msgs.scrollTop = msgs.scrollHeight;
}

function toggleThinking(msgId) {
  const block = document.getElementById(msgId + '-thinking');
  const toggle = document.getElementById(msgId + '-thinkToggle');
  if (!block || !toggle) return;
  if (block.style.display === 'none') {
    block.style.display = 'block';
    toggle.textContent = 'ğŸ’­ æ€è€ƒè¿‡ç¨‹ â–¾';
  } else {
    block.style.display = 'none';
    toggle.textContent = 'ğŸ’­ æ€è€ƒè¿‡ç¨‹ â–¸';
  }
}

function appendChatMsg(role, html, bubbleId) {
  const msgs = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'chat-msg ' + role;
  div.innerHTML = '<div class="role">' + (role === 'user' ? 'ç”¨æˆ·' : 'DeepSeek') + '</div>'
    + '<div class="bubble"' + (bubbleId ? ' id="' + bubbleId + '"' : '') + '>' + html + '</div>';
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

// ========== åˆå§‹åŒ– ==========
window.freeseek.onLog(appendLog);
window.freeseek.onAuthStatus((msg) => {
  const el = document.getElementById('authStatus');
  if (el) {
    el.textContent = msg;
    el.style.color = msg.startsWith('âœ…') ? '#4ade80' : msg.startsWith('âŒ') ? '#f87171' : '#4f8ff7';
  }
});

refreshStatus();
setInterval(refreshStatus, 5000);
</script>

</body>
</html>
